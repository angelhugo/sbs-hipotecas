<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tasas Hipotecarias SBS</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    select, input { padding: 8px; font-size: 14px; }
    #chart { width: 100%; max-width: 1100px; height: 520px; }
    .card { padding: 12px; border: 1px solid #ddd; border-radius: 10px; max-width: 1100px; }
    .muted { color: #666; }
  </style>
</head>
<body>
  <h1>Tasas hipotecarias (SBS)</h1>

  <div class="card">
    <div class="row">
      <label>Serie:
        <select id="series">
          <option value="promedio">PROMEDIO</option>
          <option value="bcp">BCP</option>
          <option value="bbva">BBVA</option>
          <option value="interbank">INTERBANK</option>
          <option value="scotiabank">SCOTIABANK</option>
        </select>
      </label>

      <label>Desde:
        <input id="from" type="date"/>
      </label>

      <label>Hasta:
        <input id="to" type="date"/>
      </label>

      <button id="apply">Aplicar</button>
    </div>

    <p id="last3" class="muted"></p>
  </div>

  <div id="chart"></div>

  <p class="muted">Fuente: SBS (tabla de tasas diarias). :contentReference[oaicite:2]{index=2}</p>

<script>
  const CSV_URL = "./data/rates.csv";

  function qs(k) {
    const u = new URL(window.location.href);
    return u.searchParams.get(k);
  }

  function toISO(d) {
    const pad = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  async function loadCSV() {
    const res = await fetch(CSV_URL, { cache: "no-store" });
    const txt = await res.text();
    const lines = txt.trim().split("\n").slice(1);
    const rows = lines.map(l => {
      const [date, series, rate] = l.split(",");
      return { date, series, rate: parseFloat(rate) };
    });
    return rows;
  }

  function filter(rows, series, from, to) {
    return rows
      .filter(r => r.series === series)
      .filter(r => (!from || r.date >= from) && (!to || r.date <= to))
      .sort((a,b) => a.date.localeCompare(b.date));
  }

  function last3Text(rows) {
    if (rows.length < 3) return "Aún no hay 3 datos para esta serie.";
    const r0 = rows[rows.length-3];
    const r2 = rows[rows.length-1];
    const delta = (r2.rate - r0.rate);
    const arrow = delta < 0 ? "↓" : (delta > 0 ? "↑" : "→");
    return `Últimos 3 datos: ${r0.date} ${r0.rate.toFixed(2)}% → ${r2.date} ${r2.rate.toFixed(2)}% (${arrow} ${delta.toFixed(2)} pp)`;
  }

  function draw(rows, series) {
    const x = rows.map(r => r.date);
    const y = rows.map(r => r.rate);

    const trace = { x, y, type: "scatter", mode: "lines+markers", name: series.toUpperCase() };

    const layout = {
      title: `Serie: ${series.toUpperCase()}`,
      xaxis: { title: "Fecha", rangeslider: { visible: true } },
      yaxis: { title: "Tasa (%)" },
      margin: { t: 50, l: 60, r: 20, b: 60 }
    };

    Plotly.newPlot("chart", [trace], layout, { responsive: true });
  }

  (async function init() {
    const all = await loadCSV();

    const seriesSel = document.getElementById("series");
    const fromInp = document.getElementById("from");
    const toInp = document.getElementById("to");
    const applyBtn = document.getElementById("apply");
    const last3 = document.getElementById("last3");

    // Defaults desde URL si existen
    const sQ = qs("series"); if (sQ) seriesSel.value = sQ;
    const fQ = qs("from");   if (fQ) fromInp.value = fQ;
    const tQ = qs("to");     if (tQ) toInp.value = tQ;

    function apply() {
      const s = seriesSel.value;
      const from = fromInp.value;
      const to = toInp.value;

      const filtered = filter(all, s, from, to);
      last3.textContent = last3Text(filtered);
      draw(filtered, s);

      // actualizar URL
      const u = new URL(window.location.href);
      u.searchParams.set("series", s);
      if (from) u.searchParams.set("from", from); else u.searchParams.delete("from");
      if (to) u.searchParams.set("to", to); else u.searchParams.delete("to");
      history.replaceState({}, "", u.toString());
    }

    // Si no hay rango, ponemos uno por defecto (últimos 365 días o lo que haya)
    if (!fromInp.value || !toInp.value) {
      const dates = all.map(r => r.date).sort();
      if (dates.length) {
        toInp.value = da
